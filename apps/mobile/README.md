# Gym Diary Mobile (`apps/mobile`)

React Native + Expo mobile client for Gym Diary. Focus: fast, offline-first workout tracking with reusable programs and structured sessions.

---

## Core concepts

- **Exercise library**
  - Local list of exercises stored on device.
  - Table: `exercises`.

- **Workout programs**
  - Reusable session blueprints (name, color, description).
  - Each program has ordered program exercises and program sets.
  - Tables: `workout_programs`, `program_exercises`, `program_sets`.

- **program folders**
  - Optional folders for organising programs.
  - Table: `program_folders`.
  - Folders only affect grouping of programs, not sessions.

- **Workout sessions**
  - Concrete workout logs.
  - Created from a program or as an empty session.
  - Snapshots of sets and exercise names so history survives program/library changes.
  - Tables: `workout_sessions`, `session_exercises`, `session_sets`.

---

## Tech stack

- **Runtime**: React Native, Expo
- **Navigation**: `expo-router`
- **Language**: TypeScript
- **Styling**: Tailwind-style utility classes via `className` (NativeWind-style)
- **Icons**: `lucide-react-native`
- **Database**: SQLite (on-device)
- **ORM**: `drizzle-orm` (SQLite driver)

---

## Directory layout

Key paths under `apps/mobile`:

- `app/`
  - Route files handled by `expo-router`.
  - `(tabs)/` holds tabbed navigation screens, e.g. `workout.tsx` for program management.
  - Session detail routes such as `session/[id].tsx` for viewing/editing single sessions.

- `src/features/`
  - `program-workout/`
    - program workout domain types, hooks, and repositories.
  - `program-folder/`
    - Folder domain types, repository, and UI components such as `FolderRow`.
  - `program-exercise/`, `program-set/`
    - program exercise and set domain + data access.
  - Future `session/` feature for session domain, repositories, hooks, and views.

- `src/lib/db/`
  - `schema.ts`
    - Drizzle schema for all mobile tables:
      - `meta`
      - `exercises`
      - `workout_programs`
      - `program_exercises`
      - `program_sets`
      - `workout_sessions`
      - `session_exercises`
      - `session_sets`
      - `program_folders`

- `db/migrations/`
  - SQL migrations generated by `drizzle-kit`.

- `db/seeds/`
  - Seed scripts such as `seed-default-exercises.ts` for populating the exercise library.

---

## Database schema overview

Short summary of the main tables.

### Exercises

- **Table**: `exercises`
- Fields:
  - `id`
  - `name`
  - `created_at`
  - `updated_at`

### Programs

- **Table**: `workout_programs`
  - `id`
  - `name`
  - `folder_id`
  - `color`
  - `description`
  - `created_at`
  - `updated_at`

- **Table**: `program_exercises`
  - `id`
  - `workout_program_id`
  - `exercise_id`
  - `order_index`
  - `note`
  - `created_at`
  - `updated_at`

- **Table**: `program_sets`
  - `id`
  - `program_exercise_id`
  - `order_index`
  - `target_reps`
  - `load_unit` (`kg`, `lb`, `band`, `bodyweight`, `none`)
  - `load_value`
  - `target_rpe`
  - `note`
  - `created_at`
  - `updated_at`

### Sessions

- **Table**: `workout_sessions`
  - `id`
  - `started_at`
  - `ended_at`
  - `source_program_id` (nullable)
  - `note`
  - `created_at`
  - `updated_at`

- **Table**: `session_exercises`
  - `id`
  - `workout_session_id`
  - `exercise_id` (nullable, FK to library)
  - `program_exercise_id` (nullable, FK to program)
  - `exercise_name` (snapshot for display)
  - `order_index`
  - `note`
  - `created_at`
  - `updated_at`

- **Table**: `session_sets`
  - `id`
  - `session_exercise_id`
  - `program_set_id` (nullable)
  - `order_index`
  - `reps`
  - `load_unit`
  - `load_value`
  - `rpe`
  - `is_warmup`
  - `note`
  - `created_at`
  - `updated_at`

### Program folders

- **Table**: `program_folders`
  - `id`
  - `name`
  - `sort_index`
  - `created_at`
  - `updated_at`

Sessions are snapshot-based:

- Deleting an exercise from `exercises` sets `session_exercises.exercise_id` to `NULL` but keeps the session.
- UI should render using `exercise_name` for history.
- Deleting programs does not remove existing sessions.

---

## Migrations

Migrations are generated from `src/lib/db/schema.ts` using `drizzle-kit`.

Example:

```bash
npx drizzle-kit generate --name alter-schema
```

Output goes to `db/migrations/` as configured in `drizzle.config.ts`.

---

## Development

Install dependencies at repo root using the chosen package manager, then from `apps/mobile` start Expo:

```bash
cd apps/mobile
npx expo start
```

Use the Expo CLI output to run on iOS simulator, Android emulator, or a physical device.

---

## Seeding local data

Default data (for example, the exercise library) is provided via scripts in `db/seeds`.

Typical flow:

1. Apply migrations so the SQLite schema matches `schema.ts`.
2. Run the seed entrypoint wired into the app or a dedicated dev-only script that imports from `db/seeds`.

Keep seed imports development-only to avoid re-seeding on every production launch.

---

## Session lifecycle (intended behaviour)

- **Start session from program**
  - Read program, its exercises, and sets.
  - Create a `workout_sessions` row with `source_program_id`.
  - Clone program exercises into `session_exercises`, including `exercise_name`.
  - Clone program sets into `session_sets`.

- **Edit session**
  - Update `session_sets` (weight, reps, RPE, warmup flag, note).
  - Add or remove `session_exercises` and `session_sets` as needed.

- **Complete session**
  - Set `ended_at` and persist changes for history.
